import Z from"./VIcons-8ee5d925.mjs";import ee from"./StripUi-e320d116.mjs";import{p as te,a as oe,e as ie,b as le,A as se,r as y,x as V,f as N,a2 as ne,o as c,i as g,j as d,k as T,u as s,F as B,z as C,C as I,c as L,l as M,Q as O,T as re,V as ae,S as ue,D as de,E as ce}from"./entry-6cd864d6.mjs";import{u as pe}from"./useUpdate-dd565c17.mjs";import{u as ve}from"./useDragAndDrop-6ee61c15.mjs";import{u as fe}from"./usePixPerSec-6b3dd217.mjs";import{s as p}from"./index-4a6215ce.mjs";import{k as me}from"./mdi-4cca1244.mjs";import ye from"./ScaleScroll-10a9e312.mjs";import he from"./SelectRect-3218b6da.mjs";import xe from"./TimeView-d605a7d8.mjs";import _e from"./TimelineCursor-86941a37.mjs";import{c as ge}from"./clone-0e5b969a.mjs";import"./useOperation-8bb78d10.mjs";import"./useKeyboard-44b65f00.mjs";import"./onDragStart-b67a33ef.mjs";function be(){const a=document.createElement("div");a.style.visibility="hidden",a.style.overflow="scroll",document.body.appendChild(a);const t=document.createElement("div");a.appendChild(t);const h=a.offsetWidth-t.offsetWidth;return a.remove(),h}const j=a=>(de("data-v-68080c3d"),a=a(),ce(),a),we={style:{display:"flex",height:"20px","border-bottom":"1px solid white"}},Se=j(()=>d("div",{style:{width:"100px","border-right":"1px solid white"}},null,-1)),Ee={class:"timeline-box",tabindex:"0"},ke={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"30px"}},Te={style:{width:"30px",height:"30px",display:"flex"}},Ie={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"70px"}},ze=["strips"],Pe={class:"flex"},Ne=j(()=>d("div",{style:{"border-right":"1px solid var(--border-grey)",width:"100px","min-width":"100px"}},null,-1)),Be=oe({__name:"TimelinePanel",setup(a){const{timeline:t,addStrip:h,removeStrips:D,selectStrip:R,changeView:v,play:U,update:z,changeTimelineTool:W,init:b}=ie(),{assets:$}=le(),{addUpdate:F}=pe(),{addEventListener:X}=se(),{dad:P}=ve(),_=y(null);V(()=>{if(!_.value)return;_.value.addEventListener("wheel",e=>{if(e.ctrlKey){const r=e.deltaY*.01,x=t.value.start-r,E=t.value.end+r;v(x,E)}else f.value+=e.deltaY,f.value<0?f.value=0:f.value>50*(w.value.length-1)&&(f.value=50*(w.value.length-1));const i=.01,l=t.value.start+e.deltaX*i;if(l<0){v(0,t.value.end);return}const n=t.value.end+e.deltaX*i;if(n>t.value.length){v(t.value.start,t.value.length);return}v(l,n)}),F(e=>{t.value.isPlay?z(t.value.curent+e/1e3):z(t.value.curent)}),window.addEventListener("keydown",e=>{var i;((i=document.activeElement)==null?void 0:i.tagName)!=="INPUT"&&e.key===" "&&U(!t.value.isPlay)}),X("resize",()=>{v(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON)}),window.addEventListener("resize",()=>{v(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON*5)})});const w=N(()=>{const o=[];for(const e of t.value.strips){if(o.length<=e.layer)for(let i=o.length;i<=e.layer;i++)o.push([]);o[e.layer].push(e)}return o.push([]),o}),Y=N(()=>t.value.strips.map(o=>({strip:o,id:p.uuid()}))),S=y(!1),f=y(0);function K(){S.value=!0}function Q(o){if(!m.value)return;S.value=!1;const e=m.value.getBoundingClientRect(),l=(t.value.end-t.value.start)/e.width;if(P.value.key==="assets"){const n=Math.floor((o.clientY-e.top)/50);u.value={effects:[],layer:n,start:(o.clientX-e.left)*l+t.value.start,length:5,id:"dummy"}}}function q(){if(S.value&&R([]),S.value=!1,!!u.value){if(P.value.key==="assets"){const o=P.value.payload;if(!o){u.value=null;return}const e=$.value.assets.find(i=>i.id===o);if((e==null?void 0:e.type)==="Video"){const i={type:"Video",videoAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},start:0,volume:1},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Image"){const i={type:"Image",imageAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},opacity:1},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Audio"){const i={type:"Audio",audioAssetId:o,animations:[],id:p.uuid(),volume:1,start:0},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Text"){const i={type:"Text",characterSpace:0,text:"Text",color:"#fff",family:"Arial",outlineColor:"#000",outlineWidth:1,size:24,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},shadowBlur:0,shadowColor:"#000",style:"normal"},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}}u.value=null}}const G=y(null),A=y(null),m=y(null);V(()=>{var o,e,i;(o=m.value)==null||o.addEventListener("scroll",()=>{var l;!A.value||(A.value.scrollTop=((l=m.value)==null?void 0:l.scrollTop)||0)}),(e=_.value)==null||e.addEventListener("mouseenter",()=>{var l;(l=_.value)==null||l.focus()}),(i=_.value)==null||i.addEventListener("keydown",l=>{if(l.key==="x"){const n=ge(t.value.selectedStrips.map(r=>r));if(t.value.selectedStrips.length>0){const r=()=>{D(n.map(x=>x.id)),n.forEach(x=>{x.effects.forEach(E=>{const k=O.get(E.id);(k instanceof re||k instanceof ae||k instanceof ue)&&(k.obj.removeFromParent(),O.delete(E.id))})})};r(),ne.push(()=>{n.forEach(x=>{h(x)}),b()},r)}}})}),y(be());const u=y();function H(o){W(o)}const J=N(()=>fe(m.value));return(o,e)=>{const i=Z,l=ee;return c(),g("div",{ref_key:"el",ref:_,class:"timeline-root",tabindex:"0"},[d("div",{ref_key:"timelineBody",ref:G,style:{width:"calc(100%)",position:"relative",overflow:"hidden"}},[d("div",we,[Se,T(xe,{start:s(t).start,length:s(t).end-s(t).start,style:{width:"calc(100% - 100px)"},onMove:e[0]||(e[0]=n=>s(z)(n,!0))},null,8,["start","length"])]),d("div",Ee,[d("div",ke,[d("div",Te,[T(i,{style:{margin:"auto"},path:s(me),fill:s(t).timelineTool=="cursor"?"white":"gray",onClick:e[1]||(e[1]=()=>H("cursor"))},null,8,["path","fill"])])]),d("div",Ie,[(c(!0),g(B,null,C(s(w),(n,r)=>(c(),g("div",{key:r,style:I(`
            border-bottom: 1px solid var(--border-grey);
            height: 50px;
            box-sizing: content-box;
            position: absolute;
            width: 100px;
            top: ${r*50-f.value}px;
          `)},null,4))),128))]),d("div",{ref_key:"timelineBox",ref:m,style:I(`width: calc(100% - ${100}px); overflow-x: clip; display: flex; position: relative; height: 100%`),onMouseup:q,onMousedown:K,onMousemove:Q},[T(_e,{style:I({left:(s(t).curent-s(t).start)*s(J)+"px"})},null,8,["style"]),m.value?(c(),L(he,{key:0,element:m.value},null,8,["element"])):M("",!0),(c(!0),g(B,null,C(s(w),(n,r)=>(c(),g("div",{key:r,strips:n,class:"layer",style:I(`top: ${r*50-f.value}px`)},null,12,ze))),128)),(c(!0),g(B,null,C(s(Y),n=>(c(),L(l,{key:n.id,strip:n.strip,top:f.value},null,8,["strip","top"]))),128)),u.value?(c(),L(l,{key:"dummy",strip:u.value},null,8,["strip"])):M("",!0)],36)]),d("div",Pe,[Ne,T(ye,{style:{position:"relative",bottom:"0"},start:s(t).start/s(t).length,end:s(t).end/s(t).length,onStart:e[2]||(e[2]=n=>s(v)(n*s(t).length,s(t).end)),onEnd:e[3]||(e[3]=n=>s(v)(s(t).start,n*s(t).length))},null,8,["start","end"])])],512)],512)}}});var Qe=te(Be,[["__scopeId","data-v-68080c3d"]]);export{Qe as default};
