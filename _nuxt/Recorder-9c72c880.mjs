import{Q as f,W as d,V as r}from"./entry-46ab768b.mjs";class c{constructor(t){this.canvas=t,this.data=[],this.audioNodes=[],this.audioCtx=new AudioContext,this.elNodeMap=new WeakMap,this.canvas=t,c.main=this}start(t){const e=this.canvas.captureStream();this.dst||(this.dst=this.audioCtx.createMediaStreamDestination()),this.recorder=new MediaRecorder(e,{mimeType:"video/webm;codecs=vp9",audioBitsPerSecond:16*1e3}),t.forEach(s=>{s.effects.forEach(n=>{const i=f.get(n.id);if(i instanceof d||i instanceof r){let a=null;if(i instanceof d?a=i.audio:i instanceof r&&(a=i.video),!a)return;let o=this.elNodeMap.get(a);o||(o=this.audioCtx.createMediaElementSource(a)),o.connect(this.dst),this.audioNodes.push(o),this.elNodeMap.set(a,o),this.dst.stream.getAudioTracks().forEach(h=>{e.addTrack(h)})}})}),this.stream=e,this.recorder.ondataavailable=s=>{this.data.push(s.data)},this.recorder.addEventListener("stop",()=>{var s;(s=this.onEnd)==null||s.call(this,new Blob(this.data))}),this.recorder.start()}stop(){var t,e;this.backAudio(),(t=this.recorder)==null||t.stop(),(e=this.dst)==null||e.disconnect(),delete this.stream,delete this.recorder}backAudio(){this.audioNodes.forEach(t=>{t.connect(this.audioCtx.destination)}),this.audioNodes=[]}}export{c as R};
