import{p as re,a as le,e as ue,b as oe,r as c,f as k,x as se,Y as ce,Z as K,w as U,u as fe,o as H,i as I,j as z,F as de,z as ve,C as he,l as pe,Q as me}from"./entry-46ab768b.mjs";import{u as ge}from"./usePixPerSec-361cd983.mjs";const te=new Map;function _e(f,l){te.set(f.toFixed(1),l)}function X(f){return te.get(f.toFixed(1))}const r=document.createElement("canvas"),A=r==null?void 0:r.getContext("2d"),ee=new Map;function ye(f){const l=ee.get(f);if(!l){const m=document.createElement("video");return ee.set(f,m),m}return l}const xe=["width"],we={style:`margin-left: ${0+4}px; display: flex; pointer-events: none;`},Me=le({__name:"VideoStripUi",props:{strip:null},setup(f){const l=f,{timeline:m}=ue(),{assets:ne}=oe(),E=c([]),P=c([]),g=k(()=>l.strip.effects.find(t=>t.type==="Video")),N=k(()=>{var t;return((t=ne.value.assets.find(n=>n.id===g.value.videoAssetId))==null?void 0:t.path)||""}),d=c(null),w=k(()=>{var t,n;return ge((n=(t=d.value)==null?void 0:t.parentElement)==null?void 0:n.parentElement)}),_=k(()=>me.get(g.value.id)),v=c(0);function j(){if(!d.value)return;const t=d.value.getBoundingClientRect();if(!_.value||_.value.video.videoHeight===0)return;const n=_.value.video.videoHeight/_.value.video.videoWidth;v.value=F/n;const u=Array(Math.ceil(t.width/v.value)+1).map((e,a)=>a);u.length!==P.value.length&&(P.value=u)}const F=40,h=ye(l.strip.id);se(()=>{var t;R.value=((t=y.value)==null?void 0:t.getContext("2d"))||null,_.value&&_.value.video.addEventListener("loadedmetadata",()=>{h.src=N.value,j(),W(!0)})});const D=c(0);let T=[];const O=async()=>{if(!d.value||!y.value)return;const t=d.value.getBoundingClientRect(),n=[];for(let e=0;e<T.length;e++){const a=T[e];a()}T=[];let u=0;y.value.width=t.width+50,E.value.forEach(e=>{if(!e||!h)return;const a=e.getBoundingClientRect(),B=8+v.value*u;n.push(()=>new Promise(i=>{T.push(()=>i());const C=setTimeout(()=>{clearTimeout(C),i()},1e3);let o=0;if(!h)return i();h.onseeked=()=>{const b=X(o);if(b){e.src=b,i();return}if(!h||!e||!r)return i();r.width=v.value,r.height=F,A==null||A.drawImage(h,0,0,r.width,r.height);const V=r==null?void 0:r.toDataURL("image/jpeg",.5);V&&(_e(o,V),e.src=V),i()},o=B/w.value+g.value.start;const p=(l.strip.start-m.value.start)*w.value;p<-50?(D.value=(p+50)%v.value,o-=(Math.floor((p+50)/a.width)+1)*v.value/w.value):D.value=0;const x=X(o);x?(e.src=x,i()):h.currentTime=o})),u++});for(let e=0;e<n.length;e++){const a=n[e];await a()}W()},M=c(null),L=c(!1);function W(t=!1){if(M.value&&!t){Q();return}L.value||(L.value=!0,fetch(N.value).then(n=>n.arrayBuffer()).then(async n=>{var e,a;if(await ce(),!(!K||!A||!((a=(e=d.value)==null?void 0:e.parentElement)==null?void 0:a.getBoundingClientRect())))try{M.value=await K.decodeAudioData(n),L.value=!1,Q()}catch{}}))}const y=c(null),R=c(null),$=k(()=>(l.strip.start-m.value.start)*w.value);function Q(){var Y,Z,q,G,J;if(!R.value)return;const t=(Z=(Y=y.value)==null?void 0:Y.parentElement)==null?void 0:Z.getBoundingClientRect(),n=(G=(q=d.value)==null?void 0:q.parentElement)==null?void 0:G.getBoundingClientRect();if(!t||!n||!M.value)return;const u=M.value.sampleRate,e=M.value.getChannelData(0),a=n.width/w.value,B=Math.floor(a*u),i=Math.floor(B/n.width)*1,C=[];let o=0,p=0,x=Math.floor(g.value.start*u);$.value<-50&&(x=Math.floor(i*(-50-$.value)));function b(s,S,ie){return Math.max(S,Math.min(ie,s))}for(let s=x;s<B+x+100;s++)if(o+=Math.abs(b(e[s],-1,1)),p++,p>=i){const S=o/i;C.push(S),o=0,p=0}if(R.value.clearRect(0,0,t.width,t.height),R.value.fillStyle="darkorange",!((J=y.value)==null?void 0:J.getBoundingClientRect()))return;const ae=1;for(let s=0;s<C.length;s++){const S=C[s+12]*40*ae;R.value.fillRect(s,40-S*2*g.value.volume,1,40)}}return U(E.value,()=>O()),U(l.strip,()=>{j(),O()}),U(m.value,()=>{j(),O()}),(t,n)=>fe(g)?(H(),I("div",{key:0,ref_key:"el",ref:d,style:{height:"100%",display:"flex",overflow:"hidden",padding:"0 4px",position:"absolute",width:"100%"}},[z("div",{style:he([`left: ${D.value+4}px`,{display:"flex","pointer-events":"none",position:"absolute"}])},[(H(!0),I(de,null,ve(P.value,(u,e)=>(H(),I("img",{key:e,ref_for:!0,ref:a=>{E.value[e]=a},width:v.value,height:F,class:"video"},null,8,xe))),128))],4),z("div",we,[z("canvas",{ref_key:"canvas",ref:y,class:"canvas",height:"40"},null,512)])],512)):pe("",!0)}});var Ce=re(Me,[["__scopeId","data-v-4884c21c"]]);export{Ce as default};
