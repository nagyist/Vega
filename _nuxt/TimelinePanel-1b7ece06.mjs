import J from"./VIcons-9f1e908b.mjs";import ee from"./StripUi-f611282e.mjs";import{a as te,u as oe,T as ie,V as le,I as se}from"./useTimeline-08cac75e.mjs";import{u as ne}from"./useUpdate-6e209676.mjs";import{k as re,a as ae,Q as ue,r as y,G as M,b as N,a6 as de,o as c,f as _,h as d,i as T,u as s,F as B,H as L,I,c as C,j as O,R as V,Z as ce,$ as pe}from"./entry-2c5f53bd.mjs";import{u as fe}from"./useDragAndDrop-0ad0a6b4.mjs";import{u as ve}from"./usePixPerSec-00d97da2.mjs";import{s as p}from"./index-ad1c0c3b.mjs";import{j as me}from"./mdi-00233b2d.mjs";import ye from"./ScaleScroll-dca77f91.mjs";import he from"./SelectRect-8cff5287.mjs";import xe from"./TimeView-292281b1.mjs";import ge from"./TimelineCursor-18852782.mjs";import{c as _e}from"./clone-0e5b969a.mjs";import"./useOperation-d09591f8.mjs";import"./useKeyboard-316e6897.mjs";import"./onDragStart-b67a33ef.mjs";function be(){const a=document.createElement("div");a.style.visibility="hidden",a.style.overflow="scroll",document.body.appendChild(a);const t=document.createElement("div");a.appendChild(t);const h=a.offsetWidth-t.offsetWidth;return a.remove(),h}const A=a=>(ce("data-v-0a7e64ee"),a=a(),pe(),a),we={style:{display:"flex",height:"20px","border-bottom":"1px solid white"}},Se=A(()=>d("div",{style:{width:"100px","border-right":"1px solid white"}},null,-1)),Ee={class:"timeline-box",tabindex:"0"},ke={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"30px"}},Te={style:{width:"30px",height:"30px",display:"flex"}},Ie={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"70px"}},Pe=["strips"],ze={class:"flex"},Ne=A(()=>d("div",{style:{"border-right":"1px solid var(--border-grey)",width:"100px","min-width":"100px"}},null,-1)),Be=ae({__name:"TimelinePanel",setup(a){const{timeline:t,addStrip:h,removeStrips:R,selectStrip:$,changeView:f,play:U,update:P,changeTimelineTool:W,init:b}=te(),{assets:D}=oe(),{addUpdate:F}=ne(),{addEventListener:X}=ue(),{dad:z}=fe(),g=y(null);M(()=>{if(!g.value)return;g.value.addEventListener("wheel",e=>{if(e.ctrlKey){const r=e.deltaY*.01,x=t.value.start-r,E=t.value.end+r;f(x,E)}else v.value+=e.deltaY,v.value<0?v.value=0:v.value>50*(w.value.length-1)&&(v.value=50*(w.value.length-1));const i=.01,l=t.value.start+e.deltaX*i;if(l<0){f(0,t.value.end);return}const n=t.value.end+e.deltaX*i;if(n>t.value.length){f(t.value.start,t.value.length);return}f(l,n)}),F(e=>{t.value.isPlay?P(t.value.curent+e/1e3):P(t.value.curent)}),window.addEventListener("keydown",e=>{var i;((i=document.activeElement)==null?void 0:i.tagName)!=="INPUT"&&e.key===" "&&U(!t.value.isPlay)}),X("resize",()=>{f(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON)}),window.addEventListener("resize",()=>{f(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON*5)})});const w=N(()=>{const o=[];for(const e of t.value.strips){if(o.length<=e.layer)for(let i=o.length;i<=e.layer;i++)o.push([]);o[e.layer].push(e)}return o.push([]),o}),Y=N(()=>t.value.strips.map(o=>({strip:o,id:p.uuid()}))),S=y(!1),v=y(0);function G(){S.value=!0}function H(o){if(!m.value)return;S.value=!1;const e=m.value.getBoundingClientRect(),l=(t.value.end-t.value.start)/e.width;if(z.value.key==="assets"){const n=Math.floor((o.clientY-e.top)/50);u.value={effects:[],layer:n,start:(o.clientX-e.left)*l+t.value.start,length:5,id:"dummy"}}}function K(){if(S.value&&$([]),S.value=!1,!!u.value){if(z.value.key==="assets"){const o=z.value.payload;if(!o){u.value=null;return}const e=D.value.assets.find(i=>i.id===o);if((e==null?void 0:e.type)==="Video"){const i={type:"Video",videoAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},start:0,volume:1},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Image"){const i={type:"Image",imageAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},opacity:1},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Audio"){const i={type:"Audio",audioAssetId:o,animations:[],id:p.uuid(),volume:1,start:0},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Text"){const i={type:"Text",characterSpace:0,text:"Text",color:"#fff",family:"Arial",outlineColor:"#000",outlineWidth:1,size:24,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},shadowBlur:0,shadowColor:"#000",style:"normal"},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}}u.value=null}}const Q=y(null),j=y(null),m=y(null);M(()=>{var o,e,i;(o=m.value)==null||o.addEventListener("scroll",()=>{var l;!j.value||(j.value.scrollTop=((l=m.value)==null?void 0:l.scrollTop)||0)}),(e=g.value)==null||e.addEventListener("mouseenter",()=>{var l;(l=g.value)==null||l.focus()}),(i=g.value)==null||i.addEventListener("keydown",l=>{if(l.key==="x"){const n=_e(t.value.selectedStrips.map(r=>r));if(t.value.selectedStrips.length>0){const r=()=>{R(n.map(x=>x.id)),n.forEach(x=>{x.effects.forEach(E=>{const k=V.effectObjectMap.get(E.id);(k instanceof ie||k instanceof le||k instanceof se)&&(k.obj.removeFromParent(),V.effectObjectMap.delete(E.id))})})};r(),de.push(()=>{n.forEach(x=>{h(x)}),b()},r)}}})}),y(be());const u=y();function Z(o){W(o)}const q=N(()=>ve(m.value));return(o,e)=>{const i=J,l=ee;return c(),_("div",{ref_key:"el",ref:g,class:"timeline-root",tabindex:"0"},[d("div",{ref_key:"timelineBody",ref:Q,style:{width:"calc(100%)",position:"relative",overflow:"hidden"}},[d("div",we,[Se,T(xe,{start:s(t).start,length:s(t).end-s(t).start,style:{width:"calc(100% - 100px)"},onMove:e[0]||(e[0]=n=>s(P)(n,!0))},null,8,["start","length"])]),d("div",Ee,[d("div",ke,[d("div",Te,[T(i,{style:{margin:"auto"},path:s(me),fill:s(t).timelineTool=="cursor"?"white":"gray",onClick:e[1]||(e[1]=()=>Z("cursor"))},null,8,["path","fill"])])]),d("div",Ie,[(c(!0),_(B,null,L(s(w),(n,r)=>(c(),_("div",{key:r,style:I(`
            border-bottom: 1px solid var(--border-grey);
            height: 50px;
            box-sizing: content-box;
            position: absolute;
            width: 100px;
            top: ${r*50-v.value}px;
          `)},null,4))),128))]),d("div",{ref_key:"timelineBox",ref:m,style:I(`width: calc(100% - ${100}px); overflow-x: clip; display: flex; position: relative; height: 100%`),onMouseup:K,onMousedown:G,onMousemove:H},[T(ge,{style:I({left:(s(t).curent-s(t).start)*s(q)+"px"})},null,8,["style"]),m.value?(c(),C(he,{key:0,element:m.value},null,8,["element"])):O("",!0),(c(!0),_(B,null,L(s(w),(n,r)=>(c(),_("div",{key:r,strips:n,class:"layer",style:I(`top: ${r*50-v.value}px`)},null,12,Pe))),128)),(c(!0),_(B,null,L(s(Y),n=>(c(),C(l,{key:n.id,strip:n.strip,top:v.value},null,8,["strip","top"]))),128)),u.value?(c(),C(l,{key:"dummy",strip:u.value},null,8,["strip"])):O("",!0)],36)]),d("div",ze,[Ne,T(ye,{style:{position:"relative",bottom:"0"},start:s(t).start/s(t).length,end:s(t).end/s(t).length,onStart:e[2]||(e[2]=n=>s(f)(n*s(t).length,s(t).end)),onEnd:e[3]||(e[3]=n=>s(f)(s(t).start,n*s(t).length))},null,8,["start","end"])])],512)],512)}}});var Ke=re(Be,[["__scopeId","data-v-0a7e64ee"]]);export{Ke as default};
