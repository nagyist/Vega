import{q as M,C as z,M as S,s as F,O as W,v as C,A as R,P as x,x as A,V,L as p,D as k,y as B,z as O,T as E,R as f}from"./entry-cf7f9e40.mjs";const q={selectedAssets:[],assets:[]},L={id:"system-text",name:"System Text",path:"",type:"Text"},H={id:"timestamp-plugin",name:"TimeStamp",path:"/scripts/plugins/timestamp.js",type:"Plugin"};function D(){const s=M("assets",()=>q,"$vKaQ1RIqzx");return{assets:s,setAssets:(t=>a=>{const i=[L,H,...a.assets.map(e=>e)].filter((e,n,o)=>o.findIndex(r=>r.id===e.id)===n);t.value={assets:i,selectedAssets:a.selectedAssets}})(s),addAsset:(t=>a=>{t.value.assets=[...t.value.assets,a]})(s),updateAsset:(t=>a=>{t.value.assets=t.value.assets.map(i=>i.id===a.id?a:i)})(s),removeAsset:(t=>a=>{t.value.assets=t.value.assets.filter(i=>i.id!==a.id)})(s)}}function U(s){return s<.5?4*s*s*s:1-Math.pow(-2*s+2,3)/2}function $(s,t,a){return(a-s)/(t-s)}function K(s,t,a){let i=-1;for(let r=0;r<s.length;r++)s[r].key===a&&s[r].time<=t&&(i=r);const e=i!==-1?s[i]:null;let n=-1;for(let r=s.length-1;r>=0;r--)s[r].key===a&&s[r].time>=t&&(n=r);const o=n!==-1?s[n]:null;return[e,o]}const G={easeInOutCubic:U,liner:s=>s};function m(s,t,a,i=0,e="liner"){if(s.filter(h=>h.key===a).length===0)return i;const[n,o]=K(s,t,a);let r=i;if(n&&o){if(n===o)return n==null?void 0:n.value;r=n.value+G[e]($(n.time,o.time,t))*(o.value-n.value)}else n&&!o?r=n.value:o&&!n&&(r=o.value);return r}class b{constructor(t){}updateStrip(t){}update(t){}}class N extends b{constructor(t){super(t),this.mesureWidth=0,this.mesureHeight=0,this.prevSize=0,this.prevText="";const a=t.effect;this.text=a.text,this.canvas=document.createElement("canvas"),this.canvas.width=2048,this.canvas.height=1024,this.ctx=this.canvas.getContext("2d"),this.texture=new z(this.canvas),this.texture.needsUpdate=!0,this.texture.premultiplyAlpha=!0,this.material=new S({map:this.texture,transparent:!0,depthTest:!0,depthWrite:!1,opacity:1,blending:F,blendSrc:W,blendDst:C,blendEquation:R,stencilWriteMask:255,stencilWrite:!0}),this.geometry=new x(1,1,1,1),this.obj=new A(this.geometry,this.material),this.obj.uuid=a.id,this.obj.position.setX(a.position.x),this.obj.position.setY(a.position.y),this.obj.position.setZ(a.position.z),t.scene.add(this.obj)}updateFont(t,a,i){if(t.size===this.prevSize&&t.text===this.prevText)return;const e=document.createElement("span");e.innerHTML=this.text,e.style.fontFamily=t.family;const n=m(t.animations,i-a.start,"size",t.size);e.style.fontSize=n+"px",e.style.fontStyle=t.style,e.style.whiteSpace="nowrap",document.body.append(e);const o=e.getBoundingClientRect();this.mesureHeight=o.height*t.text.split(`
`).length-1,e.remove(),this.prevSize=n,this.prevText=t.text}draw(t,a,i){if(!this.ctx||!this.obj||!this.canvas)return;let e=m(t.animations,i-a.start,"characterSpace",t.characterSpace);const n=m(t.animations,i-a.start,"size",t.size);this.updateFont(t,a,i),this.ctx.font=`${t.style} ${n}px ${t.family}`,this.mesureWidth=0,t.text.split(`
`).forEach((u,d)=>{const l=this.ctx.measureText(u);e||(e=0),this.mesureWidth=Math.max(l.width+e*(u.length-1),this.mesureWidth)});const o=t.text.split(`
`).length-1,r=this.mesureHeight/(o+1);this.obj.scale.set(this.canvas.width,this.canvas.height,1),this.ctx.textAlign="left",this.ctx.textBaseline="bottom",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.shadowColor=t.shadowColor,this.ctx.shadowBlur=t.shadowBlur,this.ctx.lineJoin="round",this.ctx.strokeStyle=t.outlineColor,this.ctx.lineWidth=t.outlineWidth;let h=this.canvas.width/2-this.mesureWidth/2,c=this.canvas.height/2+r/2-r/2*o;for(let u=0;u<t.text.length;u++){const d=t.text[u];if(d===`
`){c+=r,h=this.canvas.width/2-this.mesureWidth/2;continue}const l=this.ctx.measureText(d).width;this.ctx.strokeText(d,h,c),h+=l+e}this.ctx.fillStyle=t.color,this.ctx.shadowBlur=t.shadowBlur,h=this.canvas.width/2-this.mesureWidth/2,c=this.canvas.height/2+r/2-r/2*o;for(let u=0;u<t.text.length;u++){const d=t.text[u];if(d===`
`){c+=r,h=this.canvas.width/2-this.mesureWidth/2;continue}const l=this.ctx.measureText(d).width;this.ctx.fillText(d,h,c),h+=l+e}this.texture.needsUpdate=!0,this.ctx.fillStyle="red"}update({strip:t,effect:a,timeline:i,isPlay:e,jump:n}){const o=a,r=i.curent,h=m(o.animations,r-t.start,"position.x",o.position.x),c=m(o.animations,r-t.start,"position.y",o.position.y);this.obj.position.set(h,c,t.layer),t.start<=r&&r<t.start+t.length?(this.obj.visible=!0,this.draw(o,t,r)):this.obj.visible=!1}}class _ extends b{constructor(t){var o;super(t),this.type="Video",this.loaded=!1,this.videoOffset=0,this.videoDuration=0,this.event=new EventTarget,this.inProgress=!1,this.prevTime=0;const a=t.effect,i=((o=t.assets.assets.find(r=>r.id===a.videoAssetId))==null?void 0:o.path)||"";if(this.video=document.createElement("video"),this.video.controls=!0,this.canvas=document.createElement("canvas"),this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,this.ctx=this.canvas.getContext("2d"),!this.ctx)throw new Error("context2d error");this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.tex=new V(this.video),this.tex.minFilter=p,this.tex.magFilter=p;const e=new S({map:this.tex,side:k}),n=new x(this.canvas.width,this.canvas.height);this.obj=new A(n,e),a.id&&(this.obj.uuid=a.id),this.updateAsset(i),t.scene.add(this.obj)}get src(){return this.video.src}updateStrip(t){var e;const a=t.effect,i=((e=t.assets.assets.find(n=>n.id===a.videoAssetId))==null?void 0:e.path)||"";this.updateAsset(i)}updateAsset(t){this.loaded=!1;const a=()=>{!this.canvas||this.loaded||(this.videoDuration=this.video.duration,this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,this.obj.geometry=new x(this.canvas.width,this.canvas.height),this.loaded=!0,this.event.dispatchEvent(new CustomEvent("update")))};this.video.onloadedmetadata=()=>a(),this.video.src=t,this.video.load()}update({strip:t,effect:a,timeline:i,isPlay:e,jump:n}){const o=a,r=i.curent;if(this.tex&&(this.tex.needsUpdate=!0),this.ctx&&this.video&&this.ctx.drawImage(this.video,0,0),this.obj.position.copy(new B(o.position.x,o.position.y,t.layer)),!this.loaded){this.obj.visible=!1;return}o.scale||(o.scale={x:1,y:1,z:1}),this.obj.scale.set(o.scale.x,o.scale.y,1),t.start<=r&&r<t.start+t.length?(this.obj.visible=!0,this.video.volume=o.volume||1,this.prevTime!==t.start&&(this.video.currentTime=r-t.start+o.start),(e&&this.video.paused||n)&&O&&(this.inProgress||(this.inProgress=!0,this.video.play().then(()=>{this.inProgress=!1})),this.video.currentTime=r-t.start+o.start),!e&&!this.inProgress&&this.video.pause()):(this.video.volume=0,!this.video.paused&&!this.inProgress&&this.video.pause(),this.obj.visible=!1),this.prevTime=t.start}}const I=1/60;function y(s){return Math.floor(s/I)*I}class J extends b{constructor(t){var e;super(t),this.type="Audio",this.loaded=!1,this.videoOffset=0,this.inProgress=!1,this.prevTime=0;const a=t.effect;this.audio=document.createElement("audio"),document.body.append(this.audio);const i=((e=t.assets.assets.find(n=>n.id===a.audioAssetId))==null?void 0:e.path)||"";this.audio.volume=a.volume,this.updateAsset(i)}updateStrip(t){var e;const a=t.effect,i=((e=t.assets.assets.find(n=>n.id===a.audioAssetId))==null?void 0:e.path)||"";this.updateAsset(i)}updateAsset(t){this.loaded=!1;const a=()=>{this.loaded||(this.loaded=!0)};this.audio.onloadedmetadata=()=>a(),this.audio.src=t,this.audio.load()}update({strip:t,effect:a,timeline:i,isPlay:e,jump:n}){const o=a,r=i.curent;if(!this.loaded){this.audio.volume=0;return}t.start<=r&&r<t.start+t.length?(this.audio.volume=o.volume,this.prevTime!==t.start&&(this.audio.currentTime=r-t.start+o.start),(e&&this.audio.paused||n)&&O&&(this.inProgress||(this.inProgress=!0,this.audio.play().then(()=>{this.inProgress=!1})),this.audio.currentTime=r-t.start+o.start),!e&&!this.inProgress&&this.audio.pause()):(this.audio.volume=0,!this.audio.paused&&!this.inProgress&&this.audio.pause()),this.prevTime=t.start}}class Q extends b{constructor(t){var e;super(t),this.type="Image",this.playRequests=[],this.videoDuration=0,this.event=new EventTarget;const a=t.effect,i=((e=t.assets.assets.find(n=>n.id===a.imageAssetId))==null?void 0:e.path)||"";this.tex=new E().load(i,()=>{var n,o;this.obj&&this.obj.scale.set((n=this.tex)==null?void 0:n.image.width,(o=this.tex)==null?void 0:o.image.height,1)}),this.tex.minFilter=p,this.tex.magFilter=p,this.material=new S({map:this.tex,transparent:!0}),this.geometry=new x(1,1,1,1),this.obj=new A(this.geometry,this.material),a.id&&(this.obj.uuid=a.id),this.obj.position.set(a.position.x,a.position.y,0),this.updateAsset(i),t.scene.add(this.obj)}get width(){var t;return(t=this.tex)!=null&&t.image?this.tex.image.width:0}get height(){var t;return(t=this.tex)!=null&&t.image?this.tex.image.height:0}updateStrip(t){var e;const a=t.effect,i=((e=t.assets.assets.find(n=>n.id===a.imageAssetId))==null?void 0:e.path)||"";this.updateAsset(i)}updateAsset(t){var a;(a=this.tex)==null||a.dispose(),new E().load(t,i=>{this.obj&&this.obj.scale.set(1,1,1),i.needsUpdate=!0,i.minFilter=p,i.magFilter=p,this.tex=i,this.material&&(this.geometry=new x(i.image.width,i.image.height),this.obj.geometry=this.geometry,this.material.map=this.tex,this.material.needsUpdate=!0)})}update({strip:t,effect:a,timeline:i,isPlay:e,jump:n}){const o=a,r=i.curent;this.obj.position.set(o.position.x,o.position.y,t.layer),this.obj.scale.set(o.scale.x,o.scale.y,1),t.start<=r&&r<t.start+t.length?this.obj.visible=!0:this.obj.visible=!1}}const X={isRecording:!1,selectedStrips:[],selectedKeyframes:[],focusStripId:"",previewTool:"cursor",timelineTool:"cursor",isPlay:!1,width:1920,height:1080,length:15,curent:3,end:15,scale:20,start:0,strips:[]};function w(s,t){for(const a of t.strips)if(a.id===s)return a;return null}function Y(s){return(t,a,i,e)=>{const n=w(t,s.value);!n||(n.start=y(a),n.length=y(i),n.layer=e!=null?e:n.layer)}}function Z(s){return(t,a)=>{t<0&&(t=0),a>s.value.length&&(a=y(s.value.length)),a-t<1&&(a=t+1),s.value.start=y(t),s.value.end=y(a)}}const P=1/60;function tt(s){return(t,a=!1)=>{var i;t<0&&(t=0),s.value.curent=t,a&&(s.value.curent=Math.floor(t/P)*P);for(let e=0;e<s.value.strips.length;e++){const n=s.value.strips[e];for(let o=0;o<n.effects.length;o++){const r=n.effects[o],h={strip:n,effect:r,timeline:s.value,assets:{assets:[],selectedAssets:[]},jump:a,scene:f.scene,isPlay:s.value.isPlay,updateStrip:(c,u)=>{const d=w(c,s.value);if(!d)return;const l=d.effects.findIndex(v=>v.id===u.id);if(l===-1)return;const j=[];u.animations.forEach(v=>{j.find(T=>T.key===v.key&&T.time===v.time)||j.push(v)}),u.animations=j,d.effects[l]=u}};(i=f.effectObjectMap.get(r.id))==null||i.update(h)}}}}function et(s){return t=>{s.value.isPlay=t}}function at(s){return s.type==="Text"}function nt(s){return s.type==="Video"}function ot(s){return s.type==="Audio"}function rt(s){return s.type==="Image"}function st(s){return t=>{s.value=t}}const g={Video:_,Text:N,Image:Q,Audio:J};function ht(){const s=M("timeline",()=>X,"$osUqza9l1o"),t=D();return{timeline:s,init:()=>{for(const i of s.value.strips)for(const e of i.effects){const n={strip:i,effect:e,timeline:s.value,assets:t.assets.value,jump:!1,scene:f.scene,isPlay:s.value.isPlay},o=f.effectObjectMap.get(e.id);if(o)o.updateStrip(n);else if(e.type==="Plugin"&&"name"in e){const r=n.assets.assets.find(h=>h.name===e.name);if(!r)return;g[r.name]?f.effectObjectMap.set(e.id,new g[e.name](n)):require([r.path],()=>{require([r.name],h=>{g[r.name]=h.default,f.effectObjectMap.set(e.id,new g[e.name](n))})})}else f.effectObjectMap.set(e.id,new g[e.type](n))}},addStrip:(i=>e=>{i.value.strips.push(e)})(s),removeStrips:(i=>e=>{i.value.strips=i.value.strips.filter(n=>!e.includes(n.id))})(s),moveStrip:Y(s),changeView:Z(s),update:tt(s),play:et(s),setTimeline:st(s),startRecording:(i=>(e=!0)=>{i.value.isRecording=e})(s),updateLength:(i=>e=>{i.value.length=e})(s),getFisrtSelectedStrip:(i=>()=>i.value.selectedStrips.length>0?i.value.selectedStrips[0]:null)(s),setFocusStripId:(i=>e=>{i.value.focusStripId=e})(s),selectStrip:(i=>e=>{const n=e.map(o=>w(o,i.value)).filter(o=>o);i.value.selectedStrips=n})(s),updateStrip:(i=>e=>{i.value.strips=i.value.strips.map(n=>n.id===e.id?e:n)})(s),updateEffect:(i=>(e,n)=>{const o=w(e,i.value);if(!o)return;const r=o.effects.findIndex(c=>c.id===n.id);if(r===-1)return;const h=[];n.animations.forEach(c=>{h.find(u=>u.key===c.key&&u.time===c.time)||h.push(c)}),n.animations=h,o.effects[r]=n})(s),selectKeyframe:(i=>e=>{i.value.selectedKeyframes=e})(s),changeTimelineTool:(i=>e=>{i.value.timelineTool=e})(s)}}export{J as A,Q as I,N as T,_ as V,ht as a,rt as b,m as c,g as d,at as e,nt as f,X as g,ot as i,y as s,D as u};
