import H from"./VIcons-d2472329.mjs";import J from"./StripUi-349fd6e4.mjs";import{p as Q,a as Z,e as ee,b as te,A as le,r as y,x as B,f as T,o as d,i as g,j as u,k as b,u as o,F as z,z as I,C as S,c as P,l as C,D as ie,E as oe}from"./entry-c28f6d48.mjs";import{u as se}from"./useUpdate-0201ee43.mjs";import{u as ne}from"./useDragAndDrop-fb75186d.mjs";import{u as re}from"./usePixPerSec-fc9c7694.mjs";import{s as c}from"./index-352be915.mjs";import{k as ae}from"./mdi-4cca1244.mjs";import ue from"./ScaleScroll-094301d0.mjs";import de from"./SelectRect-62948dd6.mjs";import ce from"./TimeView-f9dea66f.mjs";import pe from"./TimelineCursor-6f1927d4.mjs";import"./useOperation-f589afb2.mjs";import"./useKeyboard-fa2a6ff6.mjs";import"./onDragStart-b67a33ef.mjs";function ve(){const a=document.createElement("div");a.style.visibility="hidden",a.style.overflow="scroll",document.body.appendChild(a);const t=document.createElement("div");a.appendChild(t);const h=a.offsetWidth-t.offsetWidth;return a.remove(),h}const L=a=>(ie("data-v-5289d715"),a=a(),oe(),a),fe={style:{display:"flex",height:"20px"}},me=L(()=>u("div",{style:{width:"100px","border-bottom":"1px solid white","border-right":"1px solid white"}},null,-1)),ye={class:"timeline-box",tabindex:"0"},he={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"30px"}},xe={style:{width:"30px",height:"30px",display:"flex"}},ge={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"70px"}},_e=["strips"],we={class:"flex"},be=L(()=>u("div",{style:{"border-right":"1px solid var(--border-grey)",width:"100px","min-width":"100px"}},null,-1)),Se=Z({__name:"TimelinePanel",setup(a){const{timeline:t,addStrip:h,removeStrips:A,selectStrip:V,changeView:p,play:M,update:E,changeTimelineTool:O}=ee(),{assets:D}=te(),{addUpdate:R}=se(),{addEventListener:U}=le(),{dad:k}=ne(),x=y(null);B(()=>{if(!x.value)return;x.value.addEventListener("wheel",e=>{if(e.ctrlKey){const m=e.deltaY*.01,q=t.value.start-m,G=t.value.end+m;p(q,G)}else v.value+=e.deltaY,v.value<0?v.value=0:v.value>50*(_.value.length-1)&&(v.value=50*(_.value.length-1));const s=.01,i=t.value.start+e.deltaX*s;if(i<0){p(0,t.value.end);return}const n=t.value.end+e.deltaX*s;if(n>t.value.length){p(t.value.start,t.value.length);return}p(i,n)}),R(e=>{t.value.isPlay?E(t.value.curent+e/1e3):E(t.value.curent)}),window.addEventListener("keydown",e=>{var s;((s=document.activeElement)==null?void 0:s.tagName)!=="INPUT"&&e.key===" "&&M(!t.value.isPlay)}),U("resize",()=>{p(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON)}),window.addEventListener("resize",()=>{p(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON*5)})});const _=T(()=>{const l=[];for(const e of t.value.strips){if(l.length<=e.layer)for(let s=l.length;s<=e.layer;s++)l.push([]);l[e.layer].push(e)}return l.push([]),l}),W=T(()=>t.value.strips.map(l=>({strip:l,id:c.uuid()}))),w=y(!1),v=y(0);function $(){w.value=!0}function j(l){if(!f.value)return;w.value=!1;const e=f.value.getBoundingClientRect(),i=(t.value.end-t.value.start)/e.width;k.value.key==="assets"&&(r.value={effects:[],layer:0,start:(l.clientX-e.left)*i+t.value.start,length:1,id:"x"})}function X(){if(w.value&&V([]),w.value=!1,!!r.value){if(k.value.key==="assets"){const l=k.value.payload;if(!l){r.value=null;return}const e=D.value.assets.find(s=>s.id===l);if(console.warn("TODO add three.js object to scene"),(e==null?void 0:e.type)==="Video"){const i={effects:[{type:"Video",videoAssetId:l,animations:[],id:c.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},start:0,volume:1}],layer:0,start:r.value.start,length:r.value.length,id:c.uuid()};h(i)}else if((e==null?void 0:e.type)==="Image"){const i={effects:[{type:"Image",imageAssetId:l,animations:[],id:c.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},opacity:1}],layer:0,start:r.value.start,length:r.value.length,id:c.uuid()};h(i)}else if((e==null?void 0:e.type)==="Audio"){const i={effects:[{type:"Audio",audioAssetId:l,animations:[],id:c.uuid(),volume:1,start:0}],layer:0,start:r.value.start,length:r.value.length,id:c.uuid()};h(i)}else if((e==null?void 0:e.type)==="Text"){const i={effects:[{type:"Text",characterSpace:0,text:"Text",color:"#fff",family:"Arial",outlineColor:"#000",outlineWidth:1,size:24,animations:[],id:c.uuid(),position:{x:0,y:0,z:0},shadowBlur:0,shadowColor:"#000",style:"normal"}],layer:0,start:r.value.start,length:r.value.length,id:c.uuid()};h(i)}}r.value=null}}const F=y(null),N=y(null),f=y(null);B(()=>{var l,e,s;(l=f.value)==null||l.addEventListener("scroll",()=>{var i;!N.value||(N.value.scrollTop=((i=f.value)==null?void 0:i.scrollTop)||0)}),(e=x.value)==null||e.addEventListener("mouseenter",()=>{var i;(i=x.value)==null||i.focus()}),(s=x.value)==null||s.addEventListener("keydown",i=>{i.key==="x"&&t.value.selectedStrips.length>0&&A(t.value.selectedStrips.map(n=>n.id))})}),y(ve());const r=y();function Y(l){O(l)}const K=T(()=>re(f.value));return(l,e)=>{const s=H,i=J;return d(),g("div",{ref_key:"el",ref:x,class:"timeline-root",tabindex:"0"},[u("div",{ref_key:"timelineBody",ref:F,style:{width:"calc(100%)",position:"relative",overflow:"hidden"}},[u("div",fe,[me,b(ce,{start:o(t).start,length:o(t).end-o(t).start,style:{width:"calc(100% - 100px)"},onMove:e[0]||(e[0]=n=>o(E)(n,!0))},null,8,["start","length"])]),u("div",ye,[u("div",he,[u("div",xe,[b(s,{style:{margin:"auto"},path:o(ae),fill:o(t).timelineTool=="cursor"?"white":"gray",onClick:e[1]||(e[1]=()=>Y("cursor"))},null,8,["path","fill"])])]),u("div",ge,[(d(!0),g(z,null,I(o(_),(n,m)=>(d(),g("div",{key:m,style:S(`
            border-bottom: 1px solid var(--border-grey);
            height: 50px;
            box-sizing: content-box;
            position: absolute;
            width: 100px;
            top: ${m*50-v.value}px;
          `)},null,4))),128))]),u("div",{ref_key:"timelineBox",ref:f,style:S(`width: calc(100% - ${100}px); overflow-x: clip; display: flex; position: relative; height: 100%`),onMouseup:X,onMousedown:$,onMousemove:j},[b(pe,{style:S({left:(o(t).curent-o(t).start)*o(K)+"px"})},null,8,["style"]),f.value?(d(),P(de,{key:0,element:f.value},null,8,["element"])):C("",!0),(d(!0),g(z,null,I(o(_),(n,m)=>(d(),g("div",{key:m,strips:n,class:"layer",style:S(`top: ${m*50-v.value}px`)},null,12,_e))),128)),(d(!0),g(z,null,I(o(W),n=>(d(),P(i,{key:n.id,strip:n.strip,top:v.value},null,8,["strip","top"]))),128)),r.value?(d(),P(i,{key:"dummy",strip:r.value},null,8,["strip"])):C("",!0)],36)]),u("div",we,[be,b(ue,{style:{position:"relative",bottom:"0"},start:o(t).start/o(t).length,end:o(t).end/o(t).length,onStart:e[2]||(e[2]=n=>o(p)(n*o(t).length,o(t).end)),onEnd:e[3]||(e[3]=n=>o(p)(o(t).start,n*o(t).length))},null,8,["start","end"])])],512)],512)}}});var Re=Q(Se,[["__scopeId","data-v-5289d715"]]);export{Re as default};
