import{a as re,u as le}from"./useTimeline-6cb6bf32.mjs";import{u as ue}from"./usePixPerSec-9f443e7e.mjs";import{k as oe,a as se,r as c,b as E,E as ce,J as fe,K as Y,w as L,u as de,o as U,f as I,h as N,F as ve,G as he,H as pe,j as me,R as ge}from"./entry-cf7f9e40.mjs";const te=new Map;function _e(f,l){te.set(f.toFixed(1),l)}function Z(f){return te.get(f.toFixed(1))}let r=null,x=null;const ee=new Map;function ye(f){we();const l=ee.get(f);if(!l){const m=document.createElement("video");return ee.set(f,m),m}return l}function we(){r||(r=document.createElement("canvas")),x||(x=r==null?void 0:r.getContext("2d"))}const xe=["width"],Re={style:`margin-left: ${0+4}px; display: flex; pointer-events: none;`},Me=se({__name:"VideoStripUi",props:{strip:null},setup(f){const l=f,{timeline:m}=re(),{assets:ne}=le(),A=c([]),P=c([]),g=E(()=>l.strip.effects.find(t=>t.type==="Video")),W=E(()=>{var t;return((t=ne.value.assets.find(n=>n.id===g.value.videoAssetId))==null?void 0:t.path)||""}),d=c(null),R=E(()=>{var t,n;return ue((n=(t=d.value)==null?void 0:t.parentElement)==null?void 0:n.parentElement)}),_=E(()=>ge.effectObjectMap.get(g.value.id)),v=c(0);function j(){if(!d.value)return;const t=d.value.getBoundingClientRect();if(!_.value||_.value.video.videoHeight===0)return;const n=_.value.video.videoHeight/_.value.video.videoWidth;v.value=F/n;const u=Array(Math.ceil(t.width/v.value)+1).map((e,a)=>a);u.length!==P.value.length&&(P.value=u)}const F=40,h=ye(l.strip.id);ce(()=>{var t;B.value=((t=y.value)==null?void 0:t.getContext("2d"))||null,_.value&&_.value.video.addEventListener("loadedmetadata",()=>{h.src=W.value,j(),$(!0)})});const D=c(0);let T=[];const O=async()=>{if(!d.value||!y.value)return;const t=d.value.getBoundingClientRect(),n=[];for(let e=0;e<T.length;e++){const a=T[e];a()}T=[];let u=0;y.value.width=t.width+50,A.value.forEach(e=>{if(!e||!h)return;const a=e.getBoundingClientRect(),b=8+v.value*u;n.push(()=>new Promise(i=>{T.push(()=>i());const C=setTimeout(()=>{clearTimeout(C),i()},1e3);let o=0;if(!h)return i();h.onseeked=()=>{const V=Z(o);if(V){e.src=V,i();return}if(!h||!e||!r)return i();r.width=v.value,r.height=F,x==null||x.drawImage(h,0,0,r.width,r.height);const S=r==null?void 0:r.toDataURL("image/jpeg",.5);S&&(_e(o,S),e.src=S),i()},o=b/R.value+g.value.start;const p=(l.strip.start-m.value.start)*R.value;p<-50?(D.value=(p+50)%v.value,o-=(Math.floor((p+50)/a.width)+1)*v.value/R.value):D.value=0;const w=Z(o);w?(e.src=w,i()):h.currentTime=o})),u++});for(let e=0;e<n.length;e++){const a=n[e];await a()}$()},M=c(null),H=c(!1);function $(t=!1){if(M.value&&!t){G();return}H.value||(H.value=!0,fetch(W.value).then(n=>n.arrayBuffer()).then(async n=>{var e,a;if(await fe(),!(!Y||!x||!((a=(e=d.value)==null?void 0:e.parentElement)==null?void 0:a.getBoundingClientRect())))try{M.value=await Y.decodeAudioData(n),H.value=!1,G()}catch{}}))}const y=c(null),B=c(null),z=E(()=>(l.strip.start-m.value.start)*R.value);function G(){var J,K,q,Q,X;if(!B.value)return;const t=(K=(J=y.value)==null?void 0:J.parentElement)==null?void 0:K.getBoundingClientRect(),n=(Q=(q=d.value)==null?void 0:q.parentElement)==null?void 0:Q.getBoundingClientRect();if(!t||!n||!M.value)return;const u=M.value.sampleRate,e=M.value.getChannelData(0),a=n.width/R.value,b=Math.floor(a*u),i=Math.floor(b/n.width)*1,C=[];let o=0,p=0,w=Math.floor(g.value.start*u);z.value<-50&&(w=Math.floor(i*(-50-z.value)));function V(s,k,ie){return Math.max(k,Math.min(ie,s))}for(let s=w;s<b+w+100;s++)if(o+=Math.abs(V(e[s],-1,1)),p++,p>=i){const k=o/i;C.push(k),o=0,p=0}if(B.value.clearRect(0,0,t.width,t.height),B.value.fillStyle="darkorange",!((X=y.value)==null?void 0:X.getBoundingClientRect()))return;const ae=1;for(let s=0;s<C.length;s++){const k=C[s+12]*40*ae;B.value.fillRect(s,40-k*2*g.value.volume,1,40)}}return L(A.value,()=>O()),L(l.strip,()=>{j(),O()}),L(m.value,()=>{j(),O()}),(t,n)=>de(g)?(U(),I("div",{key:0,ref_key:"el",ref:d,style:{height:"100%",display:"flex",overflow:"hidden",padding:"0 4px",position:"absolute",width:"100%"}},[N("div",{style:pe([`left: ${D.value+4}px`,{display:"flex","pointer-events":"none",position:"absolute"}])},[(U(!0),I(ve,null,he(P.value,(u,e)=>(U(),I("img",{key:e,ref_for:!0,ref:a=>{A.value[e]=a},width:v.value,height:F,class:"video"},null,8,xe))),128))],4),N("div",Re,[N("canvas",{ref_key:"canvas",ref:y,class:"canvas",height:"40"},null,512)])],512)):me("",!0)}});var Ve=oe(Me,[["__scopeId","data-v-55e06994"]]);export{Ve as default};
