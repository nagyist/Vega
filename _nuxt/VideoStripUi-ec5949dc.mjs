import{a as ie,u as re}from"./useTimeline-7b6b3688.mjs";import{u as le}from"./usePixPerSec-474d68cf.mjs";import{k as ue,a as oe,r as s,b as S,G as se,K as ce,N as Y,w as I,u as fe,o as L,f as U,h as N,F as de,H as ve,I as he,j as pe,R as me}from"./entry-a6629a66.mjs";const te=new Map;function ge(c,u){te.set(c.toFixed(1),u)}function Z(c){return te.get(c.toFixed(1))}let r=null,R=null;const ee=new Map;function _e(c){ye();const u=ee.get(c);if(!u){const v=document.createElement("video");return ee.set(c,v),v}return u}function ye(){r||(r=document.createElement("canvas")),R||(R=r==null?void 0:r.getContext("2d"))}const we=["width"],xe={style:`margin-left: ${0+4}px; display: flex; pointer-events: none;`},Re=oe({__name:"VideoStripUi",props:{strip:null},setup(c){const u=c,{timeline:v}=ie(),{assets:ne}=re(),A=s([]),E=s([]),g=S(()=>u.strip.effects.find(e=>e.type==="Video")),W=S(()=>{var e;return((e=ne.value.assets.find(n=>n.id===g.value.videoAssetId))==null?void 0:e.path)||""}),f=s(null),M=S(()=>{var e,n;return le((n=(e=f.value)==null?void 0:e.parentElement)==null?void 0:n.parentElement)}),_=S(()=>me.effectObjectMap.get(g.value.id)),h=s(0);function P(){if(!f.value)return;const e=f.value.getBoundingClientRect();if(!_.value||_.value.video.videoHeight===0)return;const n=_.value.video.videoHeight/_.value.video.videoWidth;h.value=j/n;const l=Array(Math.ceil(e.width/h.value)+1).map((t,a)=>a);l.length!==E.value.length&&(E.value=l)}const j=40,p=_e(u.strip.id);se(()=>{var e;b.value=((e=y.value)==null?void 0:e.getContext("2d"))||null,_.value&&_.value.video.addEventListener("loadedmetadata",()=>{p.src=W.value,P(),$(!0)})});const F=s(0);let T=[];const D=async()=>{if(!f.value||!y.value)return;const e=f.value.getBoundingClientRect(),n=[];for(let t=0;t<T.length;t++){const a=T[t];a()}T=[];let l=0;y.value.width=e.width+50,A.value.forEach(t=>{if(!t||!p)return;const a=t.getBoundingClientRect(),C=8+h.value*l;n.push(()=>new Promise(i=>{T.push(()=>i());const V=setTimeout(()=>{clearTimeout(V),i()},1e3);let o=0;if(!p)return i();p.onseeked=()=>{const k=Z(o);if(k){t.src=k,i();return}if(!p||!t||!r)return i();r.width=h.value,r.height=j,R==null||R.drawImage(p,0,0,r.width,r.height);const x=r==null?void 0:r.toDataURL("image/jpeg",.5);x&&(ge(o,x),t.src=x),i()},o=C/M.value+g.value.start;const m=(u.strip.start-v.value.start)*M.value;m<-50?(F.value=(m+50)%h.value,o-=(Math.floor((m+50)/a.width)+1)*h.value/M.value):F.value=0;const w=Z(o);w?(t.src=w,i()):p.currentTime=o})),l++});for(let t=0;t<n.length;t++){const a=n[t];await a()}$()},B=s(null),O=s(!1);function $(e=!1){if(B.value&&!e){G();return}O.value||(O.value=!0,fetch(W.value).then(n=>n.arrayBuffer()).then(async n=>{var t,a;if(await ce(),!(!Y||!R||!((a=(t=f.value)==null?void 0:t.parentElement)==null?void 0:a.getBoundingClientRect())))try{B.value=await Y.decodeAudioData(n),O.value=!1,G()}catch{}}))}const y=s(null),b=s(null),z=S(()=>(u.strip.start-v.value.start)*M.value);function ae(e,n,l){return Math.max(n,Math.min(l,e))}function G(){var K,q,J,Q,X;if(!b.value)return;const e=(q=(K=y.value)==null?void 0:K.parentElement)==null?void 0:q.getBoundingClientRect(),n=(Q=(J=f.value)==null?void 0:J.parentElement)==null?void 0:Q.getBoundingClientRect();if(!e||!n||!B.value)return;const l=B.value.sampleRate,t=B.value.getChannelData(0),a=n.width/M.value,C=Math.floor(a*l),i=Math.floor(C/n.width)*1,V=[];let o=0,m=0,w=Math.floor(g.value.start*l);z.value<-50&&(w=Math.floor(i*(-50-z.value)));for(let d=w;d<C+w+100;d++)if(o+=Math.abs(ae(t[d],-1,1)),m++,m>=i){const H=o/i;V.push(H),o=0,m=0}if(b.value.clearRect(0,0,e.width,e.height),b.value.fillStyle="darkorange",!((X=y.value)==null?void 0:X.getBoundingClientRect()))return;const x=1;for(let d=0;d<V.length;d++){const H=V[d+12]*40*x;b.value.fillRect(d,40-H*2*g.value.volume,1,40)}}return I(A.value,()=>D()),I(u.strip,()=>{P(),D()}),I(()=>[v.value.start,v.value.end],(e,n)=>{P(),D()}),(e,n)=>fe(g)?(L(),U("div",{key:0,ref_key:"el",ref:f,style:{height:"100%",display:"flex",overflow:"hidden",padding:"0 4px",position:"absolute",width:"100%"}},[N("div",{style:he([`left: ${F.value+4}px`,{display:"flex","pointer-events":"none",position:"absolute"}])},[(L(!0),U(de,null,ve(E.value,(l,t)=>(L(),U("img",{key:t,ref_for:!0,ref:a=>{A.value[t]=a},width:h.value,height:j,class:"video"},null,8,we))),128))],4),N("div",xe,[N("canvas",{ref_key:"canvas",ref:y,class:"canvas",height:"40"},null,512)])],512)):pe("",!0)}});var Ce=ue(Re,[["__scopeId","data-v-afadd0f8"]]);export{Ce as default};
