import ee from"./VIcons-a78ee007.mjs";import te from"./StripUi-d465c4e5.mjs";import{a as oe,u as ie,T as le,V as se,I as ne}from"./useTimeline-7b6b3688.mjs";import{u as re}from"./useUpdate-619274df.mjs";import{k as ae,a as ue,Q as de,r as y,G as V,b as B,o as c,f as g,h as d,i as I,u as s,F as L,H as C,I as P,c as M,j,a7 as ce,R as A,Z as pe,$ as fe}from"./entry-a6629a66.mjs";import{u as ve}from"./useDragAndDrop-72be2b1c.mjs";import{u as me}from"./usePixPerSec-474d68cf.mjs";import{s as p}from"./index-23426bb2.mjs";import{n as ye}from"./mdi-646f06ee.mjs";import he from"./ScaleScroll-e65f3631.mjs";import xe from"./SelectRect-1a69a828.mjs";import ge from"./TimeView-70e2389a.mjs";import _e from"./TimelineCursor-e1546eee.mjs";import{c as be}from"./clone-0e5b969a.mjs";import"./useOperation-e4c938df.mjs";import"./useKeyboard-e09c2754.mjs";import"./onDragStart-b67a33ef.mjs";function we(){const a=document.createElement("div");a.style.visibility="hidden",a.style.overflow="scroll",document.body.appendChild(a);const w=document.createElement("div");a.appendChild(w);const t=a.offsetWidth-w.offsetWidth;return a.remove(),t}const R=a=>(pe("data-v-e3a35f84"),a=a(),fe(),a),Se={style:{display:"flex",height:"20px","border-bottom":"1px solid white"}},Ee=R(()=>d("div",{style:{width:"100px","border-right":"1px solid white"}},null,-1)),ke={class:"timeline-box",tabindex:"0"},Te={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"30px"}},Ie={style:{width:"30px",height:"30px",display:"flex"}},Pe={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"70px"}},ze=["strips"],Ne={class:"flex"},Be=R(()=>d("div",{style:{"border-right":"1px solid var(--border-grey)",width:"100px","min-width":"100px"}},null,-1)),Le=ue({__name:"TimelinePanel",setup(a){const w=ce.main,{timeline:t,addStrip:_,removeStrips:U,selectStrip:$,changeView:f,play:W,update:z,changeTimelineTool:D,init:b}=oe(),{assets:F}=ie(),{addUpdate:X}=re(),{addEventListener:Y}=de(),{dad:N}=ve(),x=y(null);V(()=>{if(!x.value)return;x.value.addEventListener("wheel",e=>{if(e.ctrlKey){const r=e.deltaY*.01,h=t.value.start-r,k=t.value.end+r;f(h,k)}else v.value+=e.deltaY,v.value<0?v.value=0:v.value>50*(S.value.length-1)&&(v.value=50*(S.value.length-1));const i=.01,l=t.value.start+e.deltaX*i;if(l<0){f(0,t.value.end);return}const n=t.value.end+e.deltaX*i;if(n>t.value.length){f(t.value.start,t.value.length);return}f(l,n)}),X(e=>{t.value.isPlay?z(t.value.curent+e/1e3):z(t.value.curent)}),window.addEventListener("keydown",e=>{var i;((i=document.activeElement)==null?void 0:i.tagName)!=="INPUT"&&e.key===" "&&W(!t.value.isPlay)}),Y("resize",()=>{f(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON)}),window.addEventListener("resize",()=>{f(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON*5)})});const S=B(()=>{const o=[];for(const e of t.value.strips){if(o.length<=e.layer)for(let i=o.length;i<=e.layer;i++)o.push([]);o[e.layer].push(e)}return o.push([]),o}),G=B(()=>t.value.strips.map(o=>({strip:o,id:p.uuid()}))),E=y(!1),v=y(0);function H(){E.value=!0}function K(o){if(!m.value)return;E.value=!1;const e=m.value.getBoundingClientRect(),l=(t.value.end-t.value.start)/e.width;if(N.value.key==="assets"){const n=Math.floor((o.clientY-e.top)/50);u.value={effects:[],layer:n,start:(o.clientX-e.left)*l+t.value.start,length:5,id:"dummy"}}}function Q(){if(E.value&&$([]),E.value=!1,!!u.value){if(N.value.key==="assets"){const o=N.value.payload;if(!o){u.value=null;return}const e=F.value.assets.find(i=>i.id===o);if((e==null?void 0:e.type)==="Video"){const i={type:"Video",videoAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},start:0,volume:1},l={...u.value,effects:[i],id:p.uuid()};_(l),b()}else if((e==null?void 0:e.type)==="Image"){const i={type:"Image",imageAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},opacity:1},l={...u.value,effects:[i],id:p.uuid()};_(l),b()}else if((e==null?void 0:e.type)==="Audio"){const i={type:"Audio",audioAssetId:o,animations:[],id:p.uuid(),volume:1,start:0},l={...u.value,effects:[i],id:p.uuid()};_(l),b()}else if((e==null?void 0:e.type)==="Text"){const i={type:"Text",characterSpace:0,text:"Text",color:"#fff",family:"Arial",outlineColor:"#000",outlineWidth:1,size:24,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},shadowBlur:0,shadowColor:"#000",style:"normal"},l={...u.value,effects:[i],id:p.uuid()};_(l),b()}}u.value=null}}const Z=y(null),O=y(null),m=y(null);V(()=>{var o,e,i;(o=m.value)==null||o.addEventListener("scroll",()=>{var l;!O.value||(O.value.scrollTop=((l=m.value)==null?void 0:l.scrollTop)||0)}),(e=x.value)==null||e.addEventListener("mouseenter",()=>{var l;(l=x.value)==null||l.focus()}),(i=x.value)==null||i.addEventListener("keydown",l=>{if(l.key==="x"){const n=be(t.value.selectedStrips.map(r=>r));if(t.value.selectedStrips.length>0){const r=()=>{U(n.map(h=>h.id)),n.forEach(h=>{h.effects.forEach(k=>{const T=A.effectObjectMap.get(k.id);(T instanceof le||T instanceof se||T instanceof ne)&&(T.obj.removeFromParent(),A.effectObjectMap.delete(k.id))})})};r(),w.push(()=>{n.forEach(h=>{_(h)}),b()},r)}}})}),y(we());const u=y();function q(o){D(o)}const J=B(()=>me(m.value));return(o,e)=>{const i=ee,l=te;return c(),g("div",{ref_key:"el",ref:x,class:"timeline-root",tabindex:"0"},[d("div",{ref_key:"timelineBody",ref:Z,style:{width:"calc(100%)",position:"relative",overflow:"hidden"}},[d("div",Se,[Ee,I(ge,{start:s(t).start,length:s(t).end-s(t).start,style:{width:"calc(100% - 100px)"},onMove:e[0]||(e[0]=n=>s(z)(n,!0))},null,8,["start","length"])]),d("div",ke,[d("div",Te,[d("div",Ie,[I(i,{style:{margin:"auto"},path:s(ye),fill:s(t).timelineTool=="cursor"?"white":"gray",onClick:e[1]||(e[1]=()=>q("cursor"))},null,8,["path","fill"])])]),d("div",Pe,[(c(!0),g(L,null,C(s(S),(n,r)=>(c(),g("div",{key:r,style:P(`
            border-bottom: 1px solid var(--border-grey);
            height: 50px;
            box-sizing: content-box;
            position: absolute;
            width: 100px;
            top: ${r*50-v.value}px;
          `)},null,4))),128))]),d("div",{ref_key:"timelineBox",ref:m,style:P(`width: calc(100% - ${100}px); overflow-x: clip; display: flex; position: relative; height: 100%`),onMouseup:Q,onMousedown:H,onMousemove:K},[I(_e,{style:P({left:(s(t).curent-s(t).start)*s(J)+"px"})},null,8,["style"]),m.value?(c(),M(xe,{key:0,element:m.value},null,8,["element"])):j("",!0),(c(!0),g(L,null,C(s(S),(n,r)=>(c(),g("div",{key:r,strips:n,class:"layer",style:P(`top: ${r*50-v.value}px`)},null,12,ze))),128)),(c(!0),g(L,null,C(s(G),n=>(c(),M(l,{key:n.id,strip:n.strip,top:v.value},null,8,["strip","top"]))),128)),u.value?(c(),M(l,{key:"dummy",strip:u.value},null,8,["strip"])):j("",!0)],36)]),d("div",Ne,[Be,I(he,{style:{position:"relative",bottom:"0"},start:s(t).start/s(t).length,end:s(t).end/s(t).length,onStart:e[2]||(e[2]=n=>s(f)(n*s(t).length,s(t).end)),onEnd:e[3]||(e[3]=n=>s(f)(s(t).start,n*s(t).length))},null,8,["start","end"])])],512)],512)}}});var Qe=ae(Le,[["__scopeId","data-v-e3a35f84"]]);export{Qe as default};
