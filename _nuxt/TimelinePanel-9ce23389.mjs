import Z from"./VIcons-478a8699.mjs";import ee from"./StripUi-cd38f4fb.mjs";import{p as te,a as oe,e as ie,b as le,H as se,r as y,x as j,f as N,a5 as ne,o as c,i as _,j as d,k as T,u as s,F as B,y as L,z as I,c as C,l as A,D as M,V as re,X as ae,Y as ue,P as de,Q as ce}from"./entry-5722d099.mjs";import{u as pe}from"./useUpdate-7d51abfe.mjs";import{u as fe}from"./useDragAndDrop-4f85d13a.mjs";import{u as ve}from"./usePixPerSec-cdc6a4f2.mjs";import{s as p}from"./index-bd2fa27e.mjs";import{j as me}from"./mdi-00233b2d.mjs";import ye from"./ScaleScroll-ea2ea90a.mjs";import he from"./SelectRect-80f4322d.mjs";import xe from"./TimeView-2a59e67a.mjs";import ge from"./TimelineCursor-1528ca51.mjs";import{c as _e}from"./clone-0e5b969a.mjs";import"./useOperation-58ffd711.mjs";import"./useKeyboard-ea2bfea0.mjs";import"./onDragStart-b67a33ef.mjs";function be(){const a=document.createElement("div");a.style.visibility="hidden",a.style.overflow="scroll",document.body.appendChild(a);const t=document.createElement("div");a.appendChild(t);const h=a.offsetWidth-t.offsetWidth;return a.remove(),h}const O=a=>(de("data-v-1d4ccfb0"),a=a(),ce(),a),we={style:{display:"flex",height:"20px","border-bottom":"1px solid white"}},Se=O(()=>d("div",{style:{width:"100px","border-right":"1px solid white"}},null,-1)),Ee={class:"timeline-box",tabindex:"0"},ke={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"30px"}},Te={style:{width:"30px",height:"30px",display:"flex"}},Ie={style:{"border-right":"1px solid var(--border-grey)",height:"100%",width:"70px"}},Pe=["strips"],ze={class:"flex"},Ne=O(()=>d("div",{style:{"border-right":"1px solid var(--border-grey)",width:"100px","min-width":"100px"}},null,-1)),Be=oe({__name:"TimelinePanel",setup(a){const{timeline:t,addStrip:h,removeStrips:D,selectStrip:R,changeView:f,play:U,update:P,changeTimelineTool:W,init:b}=ie(),{assets:X}=le(),{addUpdate:Y}=pe(),{addEventListener:$}=se(),{dad:z}=fe(),g=y(null);j(()=>{if(!g.value)return;g.value.addEventListener("wheel",e=>{if(e.ctrlKey){const r=e.deltaY*.01,x=t.value.start-r,E=t.value.end+r;f(x,E)}else v.value+=e.deltaY,v.value<0?v.value=0:v.value>50*(w.value.length-1)&&(v.value=50*(w.value.length-1));const i=.01,l=t.value.start+e.deltaX*i;if(l<0){f(0,t.value.end);return}const n=t.value.end+e.deltaX*i;if(n>t.value.length){f(t.value.start,t.value.length);return}f(l,n)}),Y(e=>{t.value.isPlay?P(t.value.curent+e/1e3):P(t.value.curent)}),window.addEventListener("keydown",e=>{var i;((i=document.activeElement)==null?void 0:i.tagName)!=="INPUT"&&e.key===" "&&U(!t.value.isPlay)}),$("resize",()=>{f(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON)}),window.addEventListener("resize",()=>{f(t.value.start+Number.EPSILON,t.value.end+Number.EPSILON*5)})});const w=N(()=>{const o=[];for(const e of t.value.strips){if(o.length<=e.layer)for(let i=o.length;i<=e.layer;i++)o.push([]);o[e.layer].push(e)}return o.push([]),o}),F=N(()=>t.value.strips.map(o=>({strip:o,id:p.uuid()}))),S=y(!1),v=y(0);function H(){S.value=!0}function K(o){if(!m.value)return;S.value=!1;const e=m.value.getBoundingClientRect(),l=(t.value.end-t.value.start)/e.width;if(z.value.key==="assets"){const n=Math.floor((o.clientY-e.top)/50);u.value={effects:[],layer:n,start:(o.clientX-e.left)*l+t.value.start,length:5,id:"dummy"}}}function Q(){if(S.value&&R([]),S.value=!1,!!u.value){if(z.value.key==="assets"){const o=z.value.payload;if(!o){u.value=null;return}const e=X.value.assets.find(i=>i.id===o);if((e==null?void 0:e.type)==="Video"){const i={type:"Video",videoAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},start:0,volume:1},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Image"){const i={type:"Image",imageAssetId:o,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},opacity:1},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Audio"){const i={type:"Audio",audioAssetId:o,animations:[],id:p.uuid(),volume:1,start:0},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}else if((e==null?void 0:e.type)==="Text"){const i={type:"Text",characterSpace:0,text:"Text",color:"#fff",family:"Arial",outlineColor:"#000",outlineWidth:1,size:24,animations:[],id:p.uuid(),position:{x:0,y:0,z:0},shadowBlur:0,shadowColor:"#000",style:"normal"},l={...u.value,effects:[i],id:p.uuid()};h(l),b()}}u.value=null}}const q=y(null),V=y(null),m=y(null);j(()=>{var o,e,i;(o=m.value)==null||o.addEventListener("scroll",()=>{var l;!V.value||(V.value.scrollTop=((l=m.value)==null?void 0:l.scrollTop)||0)}),(e=g.value)==null||e.addEventListener("mouseenter",()=>{var l;(l=g.value)==null||l.focus()}),(i=g.value)==null||i.addEventListener("keydown",l=>{if(l.key==="x"){const n=_e(t.value.selectedStrips.map(r=>r));if(t.value.selectedStrips.length>0){const r=()=>{D(n.map(x=>x.id)),n.forEach(x=>{x.effects.forEach(E=>{const k=M.get(E.id);(k instanceof re||k instanceof ae||k instanceof ue)&&(k.obj.removeFromParent(),M.delete(E.id))})})};r(),ne.push(()=>{n.forEach(x=>{h(x)}),b()},r)}}})}),y(be());const u=y();function G(o){W(o)}const J=N(()=>ve(m.value));return(o,e)=>{const i=Z,l=ee;return c(),_("div",{ref_key:"el",ref:g,class:"timeline-root",tabindex:"0"},[d("div",{ref_key:"timelineBody",ref:q,style:{width:"calc(100%)",position:"relative",overflow:"hidden"}},[d("div",we,[Se,T(xe,{start:s(t).start,length:s(t).end-s(t).start,style:{width:"calc(100% - 100px)"},onMove:e[0]||(e[0]=n=>s(P)(n,!0))},null,8,["start","length"])]),d("div",Ee,[d("div",ke,[d("div",Te,[T(i,{style:{margin:"auto"},path:s(me),fill:s(t).timelineTool=="cursor"?"white":"gray",onClick:e[1]||(e[1]=()=>G("cursor"))},null,8,["path","fill"])])]),d("div",Ie,[(c(!0),_(B,null,L(s(w),(n,r)=>(c(),_("div",{key:r,style:I(`
            border-bottom: 1px solid var(--border-grey);
            height: 50px;
            box-sizing: content-box;
            position: absolute;
            width: 100px;
            top: ${r*50-v.value}px;
          `)},null,4))),128))]),d("div",{ref_key:"timelineBox",ref:m,style:I(`width: calc(100% - ${100}px); overflow-x: clip; display: flex; position: relative; height: 100%`),onMouseup:Q,onMousedown:H,onMousemove:K},[T(ge,{style:I({left:(s(t).curent-s(t).start)*s(J)+"px"})},null,8,["style"]),m.value?(c(),C(he,{key:0,element:m.value},null,8,["element"])):A("",!0),(c(!0),_(B,null,L(s(w),(n,r)=>(c(),_("div",{key:r,strips:n,class:"layer",style:I(`top: ${r*50-v.value}px`)},null,12,Pe))),128)),(c(!0),_(B,null,L(s(F),n=>(c(),C(l,{key:n.id,strip:n.strip,top:v.value},null,8,["strip","top"]))),128)),u.value?(c(),C(l,{key:"dummy",strip:u.value},null,8,["strip"])):A("",!0)],36)]),d("div",ze,[Ne,T(ye,{style:{position:"relative",bottom:"0"},start:s(t).start/s(t).length,end:s(t).end/s(t).length,onStart:e[2]||(e[2]=n=>s(f)(n*s(t).length,s(t).end)),onEnd:e[3]||(e[3]=n=>s(f)(s(t).start,n*s(t).length))},null,8,["start","end"])])],512)],512)}}});var Ke=te(Be,[["__scopeId","data-v-1d4ccfb0"]]);export{Ke as default};
