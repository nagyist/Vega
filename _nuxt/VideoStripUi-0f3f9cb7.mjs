import{p as le,a as re,e as ue,b as oe,r as c,f as T,x as se,Y as ce,Z as K,w as U,u as fe,o as H,i as I,j as z,F as de,z as ve,C as he,l as pe,Q as me}from"./entry-6cd864d6.mjs";import{u as ge}from"./usePixPerSec-6b3dd217.mjs";const te=new Map;function _e(f,r){te.set(f.toFixed(1),r)}function X(f){return te.get(f.toFixed(1))}let l=null,w=null;const ee=new Map;function ye(f){xe();const r=ee.get(f);if(!r){const m=document.createElement("video");return ee.set(f,m),m}return r}function xe(){l||(l=document.createElement("canvas")),w||(w=l==null?void 0:l.getContext("2d"))}const we=["width"],Me={style:`margin-left: ${0+4}px; display: flex; pointer-events: none;`},Re=re({__name:"VideoStripUi",props:{strip:null},setup(f){const r=f,{timeline:m}=ue(),{assets:ne}=oe(),E=c([]),P=c([]),g=T(()=>r.strip.effects.find(t=>t.type==="Video")),N=T(()=>{var t;return((t=ne.value.assets.find(n=>n.id===g.value.videoAssetId))==null?void 0:t.path)||""}),d=c(null),M=T(()=>{var t,n;return ge((n=(t=d.value)==null?void 0:t.parentElement)==null?void 0:n.parentElement)}),_=T(()=>me.get(g.value.id)),v=c(0);function j(){if(!d.value)return;const t=d.value.getBoundingClientRect();if(!_.value||_.value.video.videoHeight===0)return;const n=_.value.video.videoHeight/_.value.video.videoWidth;v.value=F/n;const u=Array(Math.ceil(t.width/v.value)+1).map((e,a)=>a);u.length!==P.value.length&&(P.value=u)}const F=40,h=ye(r.strip.id);se(()=>{var t;B.value=((t=y.value)==null?void 0:t.getContext("2d"))||null,_.value&&_.value.video.addEventListener("loadedmetadata",()=>{h.src=N.value,j(),W(!0)})});const D=c(0);let A=[];const O=async()=>{if(!d.value||!y.value)return;const t=d.value.getBoundingClientRect(),n=[];for(let e=0;e<A.length;e++){const a=A[e];a()}A=[];let u=0;y.value.width=t.width+50,E.value.forEach(e=>{if(!e||!h)return;const a=e.getBoundingClientRect(),C=8+v.value*u;n.push(()=>new Promise(i=>{A.push(()=>i());const b=setTimeout(()=>{clearTimeout(b),i()},1e3);let o=0;if(!h)return i();h.onseeked=()=>{const V=X(o);if(V){e.src=V,i();return}if(!h||!e||!l)return i();l.width=v.value,l.height=F,w==null||w.drawImage(h,0,0,l.width,l.height);const S=l==null?void 0:l.toDataURL("image/jpeg",.5);S&&(_e(o,S),e.src=S),i()},o=C/M.value+g.value.start;const p=(r.strip.start-m.value.start)*M.value;p<-50?(D.value=(p+50)%v.value,o-=(Math.floor((p+50)/a.width)+1)*v.value/M.value):D.value=0;const x=X(o);x?(e.src=x,i()):h.currentTime=o})),u++});for(let e=0;e<n.length;e++){const a=n[e];await a()}W()},R=c(null),L=c(!1);function W(t=!1){if(R.value&&!t){Q();return}L.value||(L.value=!0,fetch(N.value).then(n=>n.arrayBuffer()).then(async n=>{var e,a;if(await ce(),!(!K||!w||!((a=(e=d.value)==null?void 0:e.parentElement)==null?void 0:a.getBoundingClientRect())))try{R.value=await K.decodeAudioData(n),L.value=!1,Q()}catch{}}))}const y=c(null),B=c(null),$=T(()=>(r.strip.start-m.value.start)*M.value);function Q(){var Y,Z,q,G,J;if(!B.value)return;const t=(Z=(Y=y.value)==null?void 0:Y.parentElement)==null?void 0:Z.getBoundingClientRect(),n=(G=(q=d.value)==null?void 0:q.parentElement)==null?void 0:G.getBoundingClientRect();if(!t||!n||!R.value)return;const u=R.value.sampleRate,e=R.value.getChannelData(0),a=n.width/M.value,C=Math.floor(a*u),i=Math.floor(C/n.width)*1,b=[];let o=0,p=0,x=Math.floor(g.value.start*u);$.value<-50&&(x=Math.floor(i*(-50-$.value)));function V(s,k,ie){return Math.max(k,Math.min(ie,s))}for(let s=x;s<C+x+100;s++)if(o+=Math.abs(V(e[s],-1,1)),p++,p>=i){const k=o/i;b.push(k),o=0,p=0}if(B.value.clearRect(0,0,t.width,t.height),B.value.fillStyle="darkorange",!((J=y.value)==null?void 0:J.getBoundingClientRect()))return;const ae=1;for(let s=0;s<b.length;s++){const k=b[s+12]*40*ae;B.value.fillRect(s,40-k*2*g.value.volume,1,40)}}return U(E.value,()=>O()),U(r.strip,()=>{j(),O()}),U(m.value,()=>{j(),O()}),(t,n)=>fe(g)?(H(),I("div",{key:0,ref_key:"el",ref:d,style:{height:"100%",display:"flex",overflow:"hidden",padding:"0 4px",position:"absolute",width:"100%"}},[z("div",{style:he([`left: ${D.value+4}px`,{display:"flex","pointer-events":"none",position:"absolute"}])},[(H(!0),I(de,null,ve(P.value,(u,e)=>(H(),I("img",{key:e,ref_for:!0,ref:a=>{E.value[e]=a},width:v.value,height:F,class:"video"},null,8,we))),128))],4),z("div",Me,[z("canvas",{ref_key:"canvas",ref:y,class:"canvas",height:"40"},null,512)])],512)):pe("",!0)}});var be=le(Re,[["__scopeId","data-v-4884c21c"]]);export{be as default};
